<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>PassKey Demo</title>
    <link rel="stylesheet" type="text/css" href="/static/style.css" />
    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index/umd.min.js"></script>
  </head>

  <body>
    <div class="header">
      <h1>Passkey Demo</h1>
    </div>
    <div id="notification"></div>
    <input type="text" name="username" id="username" placeholder="Username" />
    <button onclick="registerUser()">Register</button>
    <a class="link" href="/login">Already have an account?</a>
  </body>

  <script>
    // Base64 to ArrayBuffer
    function bufferDecode(value) {
      value = value.replace(/-/g, "+").replace(/_/g, "/");
      return Uint8Array.from(atob(value), (c) => c.charCodeAt(0));
    }

    // ArrayBuffer to URLBase64
    function bufferEncode(value) {
      return btoa(String.fromCharCode.apply(null, new Uint8Array(value)))
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=/g, "");
    }
    function registerUser() {
      const username = document.getElementById("username").value;
      if (username === "") {
        alert("Please enter your username");
        return;
      }

      fetch(`/register/begin/${username}`)
        .then(function (response) {
          return response.json();
        })
        .then((credentialCreationOptions) => {
          credentialCreationOptions.publicKey.challenge = bufferDecode(
            credentialCreationOptions.publicKey.challenge,
          );
          credentialCreationOptions.publicKey.user.id = bufferDecode(
            credentialCreationOptions.publicKey.user.id,
          );

          if (credentialCreationOptions.publicKey.excludeCredentials) {
            credentialCreationOptions.publicKey.excludeCredentials.forEach(
              (item) => {
                item.id = bufferDecode(item.id);
              },
            );
          }

          return navigator.credentials.create({
            publicKey: credentialCreationOptions.publicKey,
          });
        })
        .then((credential) => {
          let attestationObject = credential.response.attestationObject;
          let clientDataJSON = credential.response.clientDataJSON;
          let rawId = credential.rawId;

          fetch(`/register/finish/${username}`, {
            method: "POST",
            body: JSON.stringify({
              id: credential.id,
              rawId: bufferEncode(rawId),
              type: credential.type,
              response: {
                attestationObject: bufferEncode(attestationObject),
                clientDataJSON: bufferEncode(clientDataJSON),
              },
            }),
            headers: {
              "Content-Type": "application/json",
            },
          });
        })
        .then(() => {
          document.getElementById("notification").innerHTML =
            "Successfully registered.";
        })
        .catch((err) => {
          console.warn(err);
          document.getElementById("notification").innerHTML =
            "Registration failed.";
        });
    }
  </script>
</html>
